<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Créer un prêt</title>
</head>
<body>
    <h2>Créer un prêt</h2>
    <form id="form-pret">
        <select name="id_type_pret" id="id_type_pret" required>
            <option value="1" data-taux="3.5">Immobilier (3.5%)</option>
            <option value="2" data-taux="1.5">Étudiant (1.5%)</option>
        </select>
        <input type="number" id="montant" placeholder="Montant du prêt" required min="1" step="0.01">
        <input type="date" id="date_pret" required>
        <input type="number" id="duree_mois" placeholder="Durée (en mois)" required min="1" step="1">
        <button type="submit">Valider le prêt</button>
        <div id="message" style="color: green;"></div>
        <div id="erreur" style="color: red;"></div>
    </form>

    <script>
    (function () {
        const apiBase = "http://localhost/t/banque/ws";

        function ajax(method, url, data, callback) {
            const xhr = new XMLHttpRequest();
            xhr.open(method, `${apiBase}${url}`, true);
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

            xhr.onreadystatechange = () => {
                if (xhr.readyState === 4) {
                    console.log("Statut HTTP :", xhr.status, "Réponse brute :", xhr.responseText);
                    try {
                        const res = JSON.parse(xhr.responseText);
                        callback(res, xhr.status);
                    } catch (e) {
                        console.error("Erreur lors du parsing JSON :", e, "Réponse brute :", xhr.responseText);
                        document.getElementById("erreur").textContent = "Erreur lors du traitement de la réponse du serveur.";
                    }
                }
            };

            xhr.onerror = () => {
                console.error("Erreur réseau lors de la requête AJAX");
                document.getElementById("erreur").textContent = "Erreur réseau, veuillez vérifier votre connexion.";
            };

            console.log("Envoi de la requête :", method, url, data);
            xhr.send(data);
        }

        function ajouterPret(event) {
            event.preventDefault(); // Empêche le rechargement de la page
            console.log("Formulaire soumis, event.preventDefault() appelé");

            // Effacer les messages précédents
            document.getElementById("message").textContent = "";
            document.getElementById("erreur").textContent = "";

            // Récupérer id_client depuis localStorage
            const utilisateur = JSON.parse(localStorage.getItem("utilisateur") || "{}");
            console.log("Contenu de localStorage.utilisateur :", utilisateur);
            const id_client = utilisateur?.id;

            if (!id_client) {
                console.error("Utilisateur non connecté, id_client manquant");
                document.getElementById("erreur").textContent = "Utilisateur non connecté. Veuillez vous reconnecter.";
                return;
            }

            const id_type_pret = document.getElementById("id_type_pret")?.value;
            const montant = parseFloat(document.getElementById("montant")?.value);
            const date_pret = document.getElementById("date_pret")?.value;
            const duree_mois_raw = document.getElementById("duree_mois")?.value;
            console.log("Valeur brute de duree_mois :", duree_mois_raw);
            const duree_mois = parseInt(duree_mois_raw, 10);

            // Validation des champs
            if (!id_type_pret || !montant || !date_pret || isNaN(duree_mois)) {
                console.error("Champs manquants ou invalides :", { id_type_pret, montant, date_pret, duree_mois });
                document.getElementById("erreur").textContent = "Veuillez remplir tous les champs avec des valeurs valides.";
                return;
            }

            if (montant <= 0 || duree_mois <= 0) {
                console.error("Validation échouée : montant ou durée_mois invalide");
                document.getElementById("erreur").textContent = "Montant et durée doivent être supérieurs à 0.";
                return;
            }

            // Validation de la date
            if (isNaN(new Date(date_pret).getTime())) {
                console.error("Date de prêt invalide :", date_pret);
                document.getElementById("erreur").textContent = "La date du prêt est invalide.";
                return;
            }

            // Calcul de la date d'échéance
            const d = new Date(date_pret);
            d.setMonth(d.getMonth() + duree_mois);
            const date_echeance = d.toISOString().split('T')[0];

            // Calcul de l'intérêt
            const taux = parseFloat(document.querySelector(`#id_type_pret option:checked`)?.dataset.taux);
            if (!taux) {
                console.error("Taux d'intérêt non défini");
                document.getElementById("erreur").textContent = "Taux d'intérêt non défini.";
                return;
            }
            const interet = (montant * taux * duree_mois) / (100 * 12);

            // Date de validation (aujourd'hui)
            const date_validation = new Date().toISOString().split('T')[0];

            // Statut par défaut (0 pour "en attente")
            const statut = 0;

            const data = `id_client=${encodeURIComponent(id_client)}&id_type_pret=${encodeURIComponent(id_type_pret)}&montant=${encodeURIComponent(montant)}&date_pret=${encodeURIComponent(date_pret)}&duree_mois=${encodeURIComponent(duree_mois)}&date_echeance=${encodeURIComponent(date_echeance)}&interet=${encodeURIComponent(interet)}&date_validation=${encodeURIComponent(date_validation)}&statut=${encodeURIComponent(statut)}`;

            ajax("POST", "/pret", data, (res, status) => {
                console.log("Réponse reçue :", res, "Statut :", status);
                if (status === 200 && res.message === "Prêt inséré avec succès") {
                    document.getElementById("message").textContent = "✅ Prêt enregistré avec succès.";
                    document.getElementById("form-pret").reset();
                } else {
                    document.getElementById("erreur").textContent = res.message || `Erreur lors de l'enregistrement du prêt (statut ${status}).`;
                }
            });
        }

        // Attacher l'événement submit explicitement
        const form = document.getElementById("form-pret");
        if (form) {
            form.addEventListener("submit", ajouterPret);
            console.log("Événement submit attaché au formulaire");
        } else {
            console.error("Formulaire #form-pret non trouvé");
        }
    })();
    </script>
</body>
</html>